<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Catatan Keuangan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        tfoot tr { border-top: 2px solid #e5e7eb; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-full max-w-6xl mx-auto">

        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">Aplikasi Catatan Keuangan</h1>
            <p class="text-slate-500 mt-2">Menampilkan & Menambah Data ke Google Spreadsheet Anda.</p>
        </div>

        <!-- Bagian Input Data Baru -->
        <div class="mb-8 p-6 bg-slate-50 rounded-lg border border-slate-200">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Tambah Transaksi Baru</h2>
            <form id="add-entry-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="entry-date" class="block text-sm font-medium text-slate-700 mb-1">Tanggal</label>
                    <input type="date" id="entry-date" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div class="lg:col-span-2">
                    <label for="entry-description" class="block text-sm font-medium text-slate-700 mb-1">Keterangan</label>
                    <input type="text" id="entry-description" placeholder="Contoh: Makan siang di kantor" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="entry-category" class="block text-sm font-medium text-slate-700 mb-1">Kategori</label>
                    <input type="text" id="entry-category" placeholder="Contoh: Food & Drink" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="entry-amount" class="block text-sm font-medium text-slate-700 mb-1">Jumlah (VND)</label>
                    <input type="number" id="entry-amount" placeholder="50000" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div class="md:col-span-2 lg:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Jenis Transaksi</label>
                    <div class="flex gap-4">
                        <label class="flex items-center"><input type="radio" name="entry-type" value="expense" class="h-4 w-4" checked> <span class="ml-2 text-sm">Pengeluaran</span></label>
                        <label class="flex items-center"><input type="radio" name="entry-type" value="income" class="h-4 w-4"> <span class="ml-2 text-sm">Pemasukan</span></label>
                    </div>
                </div>
                <button type="submit" id="submit-entry-button" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition col-span-full lg:col-span-1">
                    Simpan Transaksi
                </button>
            </form>
             <div id="form-status" class="text-center mt-4 min-h-[20px]"></div>
        </div>
        
        <!-- Tabel Data -->
        <div id="status-message" class="text-center min-h-[40px] flex items-center justify-center"></div>
        <div class="overflow-x-auto rounded-lg border border-slate-200">
            <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tanggal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Keterangan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kategori</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pemasukan</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pengeluaran</th>
                    </tr>
                </thead>
                <tbody id="data-body" class="bg-white divide-y divide-slate-200">
                    <!-- Data ditampilkan di sini -->
                </tbody>
                <tfoot id="table-foot" class="bg-slate-50 font-semibold">
                    <!-- Ringkasan Total ditampilkan di sini -->
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        // --- KONFIGURASI PENTING ---
        // GANTI BAGIAN INI DENGAN INFORMASI ANDA SEKALI SAJA
        
        // Cara mendapatkan SPREADSHEET_ID: Buka Google Sheet Anda, lihat URL di browser.
        // ID-nya adalah teks panjang di antara ".../d/" dan "/edit".
        // Contoh URL: https://docs.google.com/spreadsheets/d/INI_ADALAH_ID_NYA/edit
        const SPREADSHEET_ID = "1h7ZBahOOhbB7ZdNUduGgIw6h6N8h7G2a8q7EpEjR8i0";

        // Cara mendapatkan API_KEY: Buka Google Cloud Console, cari proyek Anda,
        // buka menu "APIs & Services" > "Credentials". Buat atau salin API Key Anda.
        // Pastikan Google Sheets API sudah diaktifkan untuk key tersebut.
        const API_KEY = "AIzaSyCNMaR1CCsaGQbcSDzjsTeTCtdc42l35tc";
        
        // URL ini didapat dari hasil deploy Google Apps Script Anda.
        // URL yang Anda berikan sudah benar dan sudah saya masukkan.
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwvXIIjJj18GT-GCddSqAahoCzyf8jpUrDkDoBYSJaMGwaiPizk4jvqQxjqkXB2SDf44A/exec";
        
        const INCOME_SHEET_NAME = "Income";
        const EXPENSE_SHEET_NAME = "Expenses";
        // --- AKHIR DARI BAGIAN KONFIGURASI ---


        // --- ELEMEN DOM ---
        const tableBody = document.getElementById('data-body');
        const tableFoot = document.getElementById('table-foot');
        const statusMessage = document.getElementById('status-message');
        const addEntryForm = document.getElementById('add-entry-form');
        const submitEntryButton = document.getElementById('submit-entry-button');
        const formStatus = document.getElementById('form-status');
        const entryDateInput = document.getElementById('entry-date');
        
        entryDateInput.valueAsDate = new Date();

        async function fetchData() {
            if (SPREADSHEET_ID === "MASUKKAN_ID_SPREADSHEET_ANDA_DI_SINI" || API_KEY === "MASUKKAN_API_KEY_ANDA_DI_SINI") {
                showError("Harap masukkan ID Spreadsheet dan API Key Anda di dalam file index.html.");
                return;
            }
            
            setLoadingState(true);
            const incomeRange = `${INCOME_SHEET_NAME}!A2:D`;
            const expenseRange = `${EXPENSE_SHEET_NAME}!A2:D`;
            const baseUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values`;

            try {
                const [incomeRes, expenseRes] = await Promise.all([
                    fetch(`${baseUrl}/${incomeRange}?key=${API_KEY}`),
                    fetch(`${baseUrl}/${expenseRange}?key=${API_KEY}`)
                ]);

                const incomeJson = await incomeRes.json();
                const expenseJson = await expenseRes.json();

                if (!incomeRes.ok) throw new Error(`Sheet Pemasukan: ${incomeJson.error.message}`);
                if (!expenseRes.ok) throw new Error(`Sheet Pengeluaran: ${expenseJson.error.message}`);
                
                renderData(incomeJson.values, expenseJson.values);

            } catch (error) {
                showError(error.message);
            } finally {
                setLoadingState(false);
            }
        }
        
        async function handleFormSubmit(event) {
            event.preventDefault(); 
            
            const entryType = document.querySelector('input[name="entry-type"]:checked').value;
            const amount = parseFloat(document.getElementById('entry-amount').value);
            const sheetName = entryType === 'income' ? INCOME_SHEET_NAME : EXPENSE_SHEET_NAME;

            const payload = {
                sheetName: sheetName,
                date: document.getElementById('entry-date').value,
                description: document.getElementById('entry-description').value,
                category: document.getElementById('entry-category').value,
                amount: entryType === 'expense' ? -Math.abs(amount) : Math.abs(amount)
            };

            setFormLoading(true);

            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    redirect: 'follow',
                    body: JSON.stringify(payload)
                });
                
                showFormStatus('Transaksi berhasil disimpan! Memuat ulang data...', 'success');
                addEntryForm.reset();
                entryDateInput.valueAsDate = new Date();
                
                setTimeout(() => {
                    fetchData();
                    showFormStatus('', 'success');
                }, 2000);

            } catch (error) {
                console.error('Error saat mengirim data:', error);
                showFormStatus('Gagal mengirim data. Periksa konsol.', 'error');
            } finally {
                setFormLoading(false);
            }
        }

        function renderData(incomeRows, expenseRows) {
            let combinedData = [];
            let totalIncome = 0;
            let totalExpense = 0;
            if (incomeRows) {
                incomeRows.forEach(row => {
                    const amount = parseFloat(row[3] || '0');
                    if(row[0]) {
                        combinedData.push({ type: 'income', date: row[0], description: row[1], category: row[2], amount: amount });
                        totalIncome += amount;
                    }
                });
            }
            if (expenseRows) {
                expenseRows.forEach(row => {
                     const amount = parseFloat(row[3] || '0');
                     if(row[0]) {
                        combinedData.push({ type: 'expense', date: row[0], description: row[1], category: row[2], amount: Math.abs(amount) });
                        totalExpense += Math.abs(amount);
                    }
                });
            }
            combinedData.sort((a, b) => new Date(b.date) - new Date(a.date));
            tableBody.innerHTML = '';
            if (combinedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">Tidak ada data.</td></tr>`;
            } else {
                combinedData.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.date || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-800">${item.description || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.category || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600">${item.type === 'income' ? formatCurrency(item.amount, 'VND') : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">${item.type === 'expense' ? formatCurrency(item.amount, 'VND') : '-'}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
            const finalBalance = totalIncome - totalExpense;
            tableFoot.innerHTML = `
                <tr>
                    <td colspan="3" class="px-6 py-3 text-right text-sm text-slate-800">Total Pemasukan</td>
                    <td class="px-6 py-3 text-right text-sm text-green-600">${formatCurrency(totalIncome, 'VND')}</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="4" class="px-6 py-3 text-right text-sm text-slate-800">Total Pengeluaran</td>
                    <td class="px-6 py-3 text-right text-sm text-red-600">${formatCurrency(totalExpense, 'VND')}</td>
                </tr>
                <tr>
                    <td colspan="4" class="px-6 py-4 text-right font-bold text-slate-800">SALDO AKHIR</td>
                    <td class="px-6 py-4 text-right font-bold ${finalBalance >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(finalBalance, 'VND')}</td>
                </tr>
            `;
        }

        function setLoadingState(isLoading) {
             if (isLoading) {
                statusMessage.innerHTML = `<div class="flex items-center gap-2"><div class="loader"></div><p class="text-slate-500">Memuat data...</p></div>`;
                tableBody.innerHTML = '';
                tableFoot.innerHTML = '';
            } else {
                statusMessage.innerHTML = '';
            }
        }
        function setFormLoading(isLoading) {
            submitEntryButton.disabled = isLoading;
            if (isLoading) {
                submitEntryButton.classList.add('opacity-50', 'cursor-not-allowed');
                submitEntryButton.innerHTML = `<div class="loader mx-auto"></div>`;
            } else {
                submitEntryButton.classList.remove('opacity-50', 'cursor-not-allowed');
                submitEntryButton.textContent = 'Simpan Transaksi';
            }
        }
        function showFormStatus(message, type) {
            formStatus.textContent = message;
            formStatus.className = `text-center mt-4 min-h-[20px] text-sm font-medium ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
        }
        function showError(message) {
            statusMessage.innerHTML = `<p class="text-red-500 font-medium text-center">${message}</p>`;
        }
        function formatCurrency(value, currency = 'VND') {
            const number = Number(value);
            if (isNaN(number)) return '-';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(number);
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', fetchData);
        addEntryForm.addEventListener('submit', handleFormSubmit);

    </script>
</body>
</html>

